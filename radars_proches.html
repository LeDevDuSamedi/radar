<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinéraire avec Radars</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <style>
        #map { height: 600px; margin-top: 20px; }
        #inputs { margin: 10px; }
    </style>
</head>
<body>
    <div id="inputs">
        <label for="start">Départ:</label>
        <input type="text" id="start" placeholder="Adresse de départ">
        <label for="end">Arrivée:</label>
        <input type="text" id="end" placeholder="Adresse d'arrivée">
        <button id="calculate-route">Calculer l'itinéraire</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        var map = L.map('map').setView([48.8566, 2.3522], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var control = L.Routing.control({
            waypoints: [],
            routeWhileDragging: true,
            createMarker: function(i, wp, nWps) {
                return L.marker(wp.latLng, {
                    draggable: true
                }).bindPopup(i === 0 ? 'Départ' : (i === nWps - 1 ? 'Arrivée' : 'Etape ' + i)).openPopup();
            }
        }).addTo(map);

        var radars = [];
        var displayedRadars = [];

        // Charger les radars depuis un fichier JSON
        fetch('radars.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau : ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                radars = data;
                console.log("Radars chargés : ", radars);
            })
            .catch(error => {
                console.error('Erreur lors du chargement des radars:', error);
                alert('Erreur lors du chargement des radars. Vérifiez le fichier JSON et le chemin.');
            });

        document.getElementById('calculate-route').addEventListener('click', function() {
            var startAddress = document.getElementById('start').value;
            var endAddress = document.getElementById('end').value;

            fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(startAddress)}`)
                .then(response => response.json())
                .then(data => {
                    var startCoords = [data.features[0].geometry.coordinates[1], data.features[0].geometry.coordinates[0]];

                    fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(endAddress)}`)
                        .then(response => response.json())
                        .then(data => {
                            var endCoords = [data.features[0].geometry.coordinates[1], data.features[0].geometry.coordinates[0]];

                            control.setWaypoints([
                                L.latLng(startCoords[0], startCoords[1]),
                                L.latLng(endCoords[0], endCoords[1])
                            ]);

                            control.getPlan().on('routesfound', function(e) {
                                var route = e.routes[0].coordinates;
                                updateRadarsOnRoute(route);
                            });
                        });
                });
        });

        function getRadarIcon(type) {
            var iconUrl;
            switch (type) {
                case 'discriminants':
                    iconUrl = 'img/big.png';
                    break;
                case 'fixe':
                    iconUrl = 'img/classic.png';
                    break;
                case 'feu rouge':
                    iconUrl = 'img/light.png';
                    break;
                case 'itineraire':
                    iconUrl = 'img/Unknown.png';
                    break;
                default:
                    iconUrl = 'img/Unknown.png';
            }

            return L.icon({
                iconUrl: iconUrl,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }

        function updateRadarsOnRoute(route) {
            displayedRadars.forEach(marker => map.removeLayer(marker));
            displayedRadars = [];

            var routePolyline = L.polyline(route, {color: 'blue'}).addTo(map);

            radars.forEach(function(radar) {
                var radarLatLng = L.latLng(radar.lat, radar.lng);

                if (isRadarOnRoute(radarLatLng, route)) {
                    var marker = L.marker([radar.lat, radar.lng], { icon: getRadarIcon(radar.type) })
                        .bindPopup(`Radar ID: ${radar.id}, Type: ${radar.typeLabel}`);
                    marker.addTo(map);
                    displayedRadars.push(marker);
                }
            });
        }

        function isRadarOnRoute(radarLatLng, route) {
            // Précision de la vérification (en mètres)
            var tolerance = 50;

            var polyline = L.polyline(route);
            return route.some(function(point, index) {
                var nextPoint = route[index + 1];
                if (nextPoint) {
                    var segment = L.latLngBounds([point, nextPoint]);
                    return segment.contains(radarLatLng) && radarLatLng.distanceTo(L.latLng(point)) < tolerance;
                }
                return false;
            });
        }
    </script>
</body>
</html>
